<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title> Main </title>
    <script type="text/javascript" src="User.js"></script>
    <script type="text/javascript" src="Post.js"></script>
    <script type="text/javascript" src="Cluster.js"></script>
    <script type="text/javascript" src="ActiveUser.js"></script>
    <script type="text/javascript" src="ActiveUserTable.js"></script>
    <script type="text/javascript" src="Comment.js"></script>
    <script type="text/javascript" src="Server.js"></script>
    <script type="text/javascript" src="clustering.js"></script>
    <script type="text/javascript" src="data.js"></script>
    <script>
        console.log(data_users);
        var results_ped = null;
        var results_car = null;
        var post_threshold = 500;
        var optics = new OPTICS();
        // var users = {};
        // users[1] = new ActiveUser(30, 30, 0, null, null, "minneapolis", 1);
        // users[2] = new ActiveUser(30, 33, 0, null, null, "minneapolis", 2);
        // users[3] = new ActiveUser(49, 49, 0, null, null, "minneapolis", 3);
        // users[4] = new ActiveUser(33, 33, 0, null, null, "minneapolis", 4);
        // users[5] = new ActiveUser(36, 36, 0, null, null, "minneapolis", 5);
        // users[6] = new ActiveUser(1, 1, 0, null, null, "minneapolis", 6);
        // users[7] = new ActiveUser(0, 1, 0, null, null, "minneapolis", 7);
        // users[8] = new ActiveUser(1, 0, 0, null, null, "minneapolis", 8);
        // users[9] = new ActiveUser(10, 10, 0, null, null, "minneapolis", 9);
        // users[10] = new ActiveUser(10, 13, 0, null, null, "minneapolis", 10);
        // users[11] = new ActiveUser(13, 13, 0, null, null, "minneapolis", 11);

        var posts_car = {};
        var posts_ped = {};
        var car_cluster = [];
        // posts_ped[1] = new Post(30, 30, "this is jason", null, 1, 1, null, 0);
        // posts_ped[2] = new Post(30, 30, "this is jason", null, 2, 1, null, 0);
        // posts_ped[3] = new Post(30, 30, "this is jason", null, 3, 1, null, 0);
        // posts_ped[4] = new Post(30, 30, "this is jason", null, 4, 1, null, 0);
        // posts_ped[5] = new Post(49, 49, "this is jason", null, 5, 1, null, 0);
        // posts_ped[6] = new Post(10, 10, "this is jason", null, 6, 1, null, 0);
        // posts_ped[7] = new Post(100, 100, "this is jason", null, 7, 1, null, 0);
        // posts_ped[8] = new Post(1, 1, "this is jason", null, 1, 8, null, 0);
        // posts_ped[9] = new Post(2, 2, "this is jason", null, 1, 9, null, 0);

        function getUserById(id, users){  // this function gets the user by its id
            return users[id];
        }

        function getProjectionFromUsersToSubset(users){  // get a subprojection from the user sets and preset for the clustering (x, y, id)
            var projection_ped = [];
            var projection_car = [];
            Object.keys(users).forEach(function(key) {
                var user = users[key];
                if (user.speed > 1.4){
                    projection_car.push([user.x, user.y, user.activeID]);
                }
                else{
                    projection_ped.push([user.x, user.y, user.activeID, user.speed]);
                }
                
            });
            return [projection_ped, projection_car];
        }

        // this function takes in a result from optics, a projection from users, all users, posts needed to clustify
        function populatePedCluster(results, tempview, users, posts){  // clustering + populate posts
            var clusterlist = [];
            var count = 0;
            console.log(results);
            console.log(tempview);
            for (var i = 0; i < results.length; i++){  // cluster users
                var cluster = new Cluster(count);
                for (var j = 0; j < results[i].length; j++){
                    var userobj = getUserById(tempview[results[i][j]][2], users);
                    userobj.clusterID = count;
                    cluster.users.push(userobj);
                }
                clusterlist.push(cluster);
                count++;
            }
            Object.keys(posts).forEach(function(key) {  // populate posts
                var post = posts[key];
                var acc = Math.pow(2, 30);
                var result = null;
                Object.keys(users).forEach(function(newkey){
                    var user = users[newkey];
                    var dis = Math.pow((post.x - user.x), 2) + Math.pow((post.y - user.y), 2);
                    if (dis < post_threshold){ // if distance more than this, do not consider
                        if (dis < acc){
                            acc = dis;
                            result = user;
                        }
                    }
                });
                if (result != null){
                    clusterlist[result.clusterID].posts.push(post);
                }
            });
            return clusterlist;
        }


        // previous
        // results
        // tempview
        // users
        // posts
        function populateCarCluster(previous, results, tempview, users, posts){ 
            var clusterlist = [];
            var count = 0;
            for (var i = 0; i < results.length; i++){  // cluster users
                var value;
                var map = results[i];
                console.log(map);
                Object.keys(map).forEach(function(key) {
                    value = map[key];
                    var cluster = new Cluster(count);
                    for (var j = 0; j < value.length; j++){
                        var userobj = getUserById(tempview[value[j]][2], users);
                        userobj.clusterID = count;
                        cluster.users.push(userobj);
                    }
                    clusterlist.push(cluster);
                    count++;

                });
            }

            // if previous does not exist, then we do not need to worry about getting posts over
            if (previous.length != 0){ // duplicate over posts from previous cluster post
                for (var i = 0; i < clusterlist.length; i++){
                    var newcluster = clusterlist[i];
                    var matchcluster = null;
                    var acc = 0;
                    var number_of_new_user = newcluster.users.length;
                    for (var j = 0; j < previous.length; j++){
                        var oldcluster = previous[j];
                        var d = {};
                        for (var k = 0; k < newcluster.users.length; k++){
                            d[newcluster.users[k].id] = 0;
                        }
                        for (var k = 0; k < oldcluster.users.length; k++){
                            d[oldcluster.users[k].id] = 0;
                        }
                        var temp = oldcluster.users.length + number_of_new_user - Object.keys(d).length;  // # of same people in the group
                        if (temp > acc){
                            acc = temp;
                            matchcluster = oldcluster;
                        }
                    }
                    if (matchcluster != null){
                        for (var k = 0; k < matchcluster.posts.length; k++){
                            newcluster.push(matchcluster.posts[k]);
                        }
                    }
                }
                previous = clusterlist;
            }
            return clusterlist;
            
        }

        function addPost(post, users, car_cluster, ped_cluster, posts){ // get user id and his or her cluster ID, then update to the cluster for the post
            var cid = getUserById(post.posterid, users).clusterID;
            if (post.speed == 0){
                car_cluster[cid].posts.push(post);
            }
            else{
                ped_cluster[cid].posts.push(post);
            }
            posts.push(post);
            return;
        }


        var views = [];
        views = getProjectionFromUsersToSubset(data_users);
        var view_ped = views[0];
        var view_car = views[1];
        console.log("###############\nview ped\n################################");
        console.log(view_ped);
        console.log("###############\nview car\n################################");
        console.log(view_car);
        console.log("###############\nnow ped\n################################");
        if (view_ped.length > 0){
            results_ped = optics.run(view_ped, 1.1, 2);  // max distance, 2 is the minimum member
            var finalcluster = populatePedCluster(results_ped, view_ped, data_users, posts_ped);
            console.log(finalcluster);
        }
        console.log("###############\nnow car\n################################");
        if (view_car.length > 0){
            results_car = optics.run(view_car, 1.01, 2);
            console.log(results_car);
            var divided_cluster = [];
            for (var i = 0; i < results_car.length; i++){
                var subcluster = {};
                var onegroup = results_car[i];
                for (var j = 0; j < onegroup.length; j++){ // iterate over each optics result index
                    if (subcluster[onegroup[j][3]] != undefined){ // already a hash key on speed
                        subcluster[onegroup[j][3]].push(onegroup[j]);
                    }
                    else{
                        subcluster[onegroup[j][3]] = [];
                        subcluster[onegroup[j][3]].push(onegroup[j]);
                    }
                }

                divided_cluster.push(subcluster);
            }

            console.log(divided_cluster);

            // now the divided_cluster has first x,y optics cluster and also divided into speed cluster
            car_cluster = populateCarCluster(car_cluster, divided_cluster, view_car, data_users, posts_car);
            console.log(car_cluster);
        }

// to do, get x, y center for cluster.


    </script>
</head>
<body>
<div>

</div>
</body>
</html>